{% extends "base.html" %}

{% block title %}Inbox - Email Productivity Agent{% endblock %}

{% block content %}
<div class="main-content-area">
    <!-- Gmail Toolbar -->
    <div class="gmail-toolbar">
        <div class="toolbar-left">
            <label class="checkbox-wrapper">
                <input type="checkbox" class="email-checkbox" id="selectAll" onchange="toggleSelectAll(this)">
            </label>
            <button class="icon-btn" onclick="refreshInbox()" title="Refresh">
                <span class="material-icons">refresh</span>
            </button>
            <button class="icon-btn" onclick="showMoreActions()" title="More actions">
                <span class="material-icons">more_vert</span>
            </button>
        </div>
        <div class="toolbar-right">
            <span class="result-count">1-{{ emails|length }} of {{ emails|length }}</span>
            <button class="icon-btn" onclick="goToPrevious()" title="Previous page">
                <span class="material-icons">chevron_left</span>
            </button>
            <button class="icon-btn" onclick="goToNext()" title="Next page">
                <span class="material-icons">chevron_right</span>
            </button>
        </div>
    </div>

    {% if emails|length == 0 %}
    <div class="empty-state">
        <p>No emails loaded. Click "Load Inbox" to get started.</p>
    </div>
    {% else %}
    <!-- Gmail Email List -->
    <div class="gmail-email-list">
    {% for email in emails %}
    <div class="gmail-email-row" onclick="viewEmail('{{ email.id }}')">
        <div class="email-row-left">
            <label class="checkbox-wrapper" onclick="event.stopPropagation()">
                <input type="checkbox" class="email-checkbox" data-email-id="{{ email.id }}">
            </label>
            <button class="star-btn" onclick="event.stopPropagation(); toggleStar(this, '{{ email.id }}');" title="Star">
                <span class="material-icons">star_border</span>
            </button>
            <button class="important-btn" onclick="event.stopPropagation(); toggleImportant(this, '{{ email.id }}');" title="Mark as important">
                <span class="material-icons">label_important</span>
            </button>
        </div>
        
        <div class="email-row-content">
            <div class="email-sender">{{ email.sender_name or email.sender }}</div>
            <div class="email-subject-line">
                <span class="email-subject">{{ email.subject }}</span>
                <span class="email-preview"> - {{ email.body[:100] }}...</span>
            </div>
            {% if email.processed and email.processed.category %}
            <div class="email-badges">
                <span class="gmail-badge {{ email.processed.category.category|lower|replace('-', '') }}">
                    {{ email.processed.category.category }}
                </span>
            </div>
            {% endif %}
        </div>
        
        <div class="email-row-right">
            <span class="email-time">{{ email.timestamp[:5] if email.timestamp else 'Now' }}</span>
        </div>
    </div>
    {% endfor %}
    </div>
    {% endif %}

    {% if selected_email %}
    <div class="email-detail-overlay" onclick="closeEmailDetail()">
        <div class="email-detail-panel" onclick="event.stopPropagation()">
            <div class="email-detail-header">
                <h2>üìß Email Details</h2>
                <button class="close-btn" onclick="closeEmailDetail()" title="Close">
                    <span class="material-icons">close</span>
                </button>
            </div>
            <div class="detail-content">
                <p><strong>From:</strong> {{ selected_email.sender_name or selected_email.sender }}</p>
                <p><strong>Subject:</strong> {{ selected_email.subject }}</p>
                <p><strong>Date:</strong> {{ selected_email.timestamp }}</p>
                
                <h3>Body:</h3>
                <div class="email-body">{{ selected_email.body }}</div>
                
                <div class="detail-actions">
                    <button class="btn btn-primary" onclick="generateReply('{{ selected_email.id }}')">‚úçÔ∏è Draft Reply</button>
                    <button class="btn btn-secondary" onclick="reprocessEmail('{{ selected_email.id }}')">üîÑ Re-process</button>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

{% endblock %}

{% block scripts %}
<script>
    function filterEmails() {
        const category = document.getElementById('categoryFilter').value;
        window.location.href = `{{ url_for('inbox') }}?category=${category}`;
    }
    
    function viewEmail(emailId) {
        $.post(`/api/select-email/${emailId}`, function(data) {
            if (data.success) {
                location.reload();
            }
        });
    }

    function closeEmailDetail() {
        $.post('/api/deselect-email', function() {
            window.location.reload();
        });
    }
    
    function generateReply(emailId) {
        if (!confirm('Generate a reply draft for this email?')) return;
        $.post(`/api/generate-reply/${emailId}`, function(data) {
            if (data.success) {
                alert('‚úÖ Draft created!');
                window.location.href = '{{ url_for("drafts") }}';
            } else {
                alert(`‚ùå Error: ${data.error}`);
            }
        });
    }
    
    function reprocessEmail(emailId) {
        $.post(`/api/process-email/${emailId}`, function(data) {
            if (data.success) {
                alert('‚úÖ Email re-processed!');
                location.reload();
            } else {
                alert(`‚ùå Error: ${data.error}`);
            }
        });
    }
</script>
{% endblock %}
