{% extends "base.html" %}

{% block title %}Chat - Email Productivity Agent{% endblock %}

{% block content %}
<div class="page-header">
    <h1>ğŸ’¬ Email Agent Chat</h1>
    <p>Ask questions about your inbox, get summaries, or request actions</p>
</div>

<div class="chat-container">
    <div class="chat-messages" id="chatMessages">
        {% for msg in chat_history %}
        <div class="message {{ msg.role }}">
            <div class="message-content">{{ msg.content|replace('\n', '<br>')|safe }}</div>
        </div>
        {% endfor %}
    </div>
    
    <div class="chat-input-container">
        <input type="text" id="chatInput" class="chat-input" placeholder="Ask about your emails..." onkeypress="handleKeyPress(event)">
        <button class="btn btn-primary" onclick="sendMessage()">Send</button>
    </div>
    
    <div class="quick-actions">
        <h4>ğŸ’¡ Quick Actions:</h4>
        <button class="btn btn-secondary btn-sm" onclick="quickAction('What tasks do I need to do?')">ğŸ“‹ Show all tasks</button>
        <button class="btn btn-secondary btn-sm" onclick="quickAction('Show me all urgent or important emails')">âš¡ Show urgent emails</button>
        <button class="btn btn-secondary btn-sm" onclick="quickAction('Give me a summary of my inbox')">ğŸ“Š Inbox summary</button>
        <button class="btn btn-danger btn-sm" onclick="clearChat()">ğŸ—‘ï¸ Clear Chat</button>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    function scrollToBottom() {
        const messages = document.getElementById('chatMessages');
        messages.scrollTop = messages.scrollHeight;
    }
    
    function handleKeyPress(event) {
        if (event.key === 'Enter') {
            sendMessage();
        }
    }
    
    function sendMessage() {
        const input = document.getElementById('chatInput');
        const query = input.value.trim();
        
        if (!query) return;
        
        // Add user message to UI
        addMessage('user', query);
        input.value = '';
        
        // Send to server
        $.ajax({
            url: '/api/chat',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({query: query}),
            success: function(data) {
                if (data.success) {
                    const answer = data.response.answer || 'Sorry, I could not process that request.';
                    addMessage('assistant', answer);
                    
                    if (data.response.suggested_actions && data.response.suggested_actions.length > 0) {
                        let actions = '\n\nSuggested Actions:\n';
                        data.response.suggested_actions.forEach(action => {
                            actions += `â€¢ ${action}\n`;
                        });
                        addMessage('assistant', actions.trim());
                    }
                } else {
                    addMessage('assistant', `âŒ Error: ${data.error}`);
                }
            },
            error: function() {
                addMessage('assistant', 'âŒ Error: Failed to send message');
            }
        });
    }
    
    function addMessage(role, content) {
        const messages = document.getElementById('chatMessages');
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${role}`;
        
        // Format content: preserve line breaks and escape HTML
        const formattedContent = content
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/\n/g, '<br>');
        
        messageDiv.innerHTML = `<div class="message-content">${formattedContent}</div>`;
        messages.appendChild(messageDiv);
        scrollToBottom();
    }
    
    function quickAction(query) {
        document.getElementById('chatInput').value = query;
        sendMessage();
    }
    
    function clearChat() {
        if (!confirm('Clear chat history?')) return;
        
        $.post('/api/clear-chat', function(data) {
            if (data.success) {
                location.reload();
            }
        });
    }
    
    // Scroll to bottom on load
    window.onload = scrollToBottom;
</script>
{% endblock %}
